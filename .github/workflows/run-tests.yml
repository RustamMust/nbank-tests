name: Run tests

# триггер
on: [ push, workflow_dispatch ]

jobs: # аналог этапов
  run-tests:
    name: Set up services (review apps) and run tests
    runs-on: ubuntu-latest
    steps: # шаги конкретной job
      - name: Checkout repository # копируем файлы репозитория внутрь CI агента
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'corretto'
          java-version: '21'

      - name: Cache Maven repository
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Install jq if needed
        run: |
          if ! command -v jq &> /dev/null; then
            echo "Installing jq..."
            sudo apt-get update && sudo apt-get install -y jq
          else
            echo "jq is already installed: $(jq --version)"
          fi

      - name: Set up services
        run: cd infra/docker_compose && bash restart_docker.sh && cd ../..

      - name: Wait for services to be ready
        run: |
          echo "Waiting for services to start..."
          sleep 20
          echo "Checking services status..."
          docker ps
          echo "Checking if services are accessible..."
          timeout 30 bash -c 'until curl -f http://localhost:4111/actuator/health 2>/dev/null; do echo "Waiting for backend..."; sleep 2; done' || true
          timeout 30 bash -c 'until curl -f http://localhost:4444/status 2>/dev/null; do echo "Waiting for Selenoid..."; sleep 2; done' || true
          timeout 30 bash -c 'until curl -f http://localhost:80 2>/dev/null; do echo "Waiting for frontend..."; sleep 2; done' || true

      - name: Make Maven wrapper executable
        run: chmod +x ./mvnw

      - name: Run API tests
        run: ./mvnw clean test -q -P api
        env:
          APIBASEURL: http://localhost:4111
          APIVERSION: /api/v1

      - name: Run UI tests
        run: ./mvnw clean test -q -P ui
        env:
          APIBASEURL: http://localhost:4111
          UIBASEURL: http://nginx:80
          UIREMOTE: http://localhost:4444/wd/hub
          APIVERSION: /api/v1

      - name: Run Swagger coverage
        if: always()
        run: |
          chmod +x ./.swagger-coverage-commandline/bin/swagger-coverage-commandline
          ./.swagger-coverage-commandline/bin/swagger-coverage-commandline \
          -s http://localhost:4111/v3/api-docs \
          -i target/swagger-coverage-output

      # ------------------------
      # LOAD HISTORY FROM GH-PAGES
      # ------------------------
      - name: Load test report history
        uses: actions/checkout@v4
        if: always()
        with:
          ref: gh-pages
          path: gh-pages

      # ------------------------
      #   INSTALL ALLURE CLI
      # ------------------------
      - name: Download Allure CLI
        if: always()
        run: |
          wget https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.zip
          unzip allure-2.27.0.zip -d allure

      # ------------------------
      #   GENERATE ALLURE REPORT
      # ------------------------
      - name: Build Allure Test Report
        if: always()
        run: |
          ./allure/allure-2.27.0/bin/allure generate target/allure-results \
            -o allure-report --clean
                
          # story:
          # переносим историю
          rm -rf allure-report/history
          if [ -d gh-pages/history ]; then
            cp -R gh-pages/history allure-report/
          fi
          
          # сохраняем историю для следующего запуска
          mkdir -p allure-history
          cp -R allure-report/* allure-history/
            
      # ------------------------
      # SWAGGER COVERAGE → ВСТРАИВАЕМ В ALLURE
      # ------------------------
      - name: Build Swagger coverage report
        if: always()
        run: |
          mkdir -p allure-history/${GITHUB_RUN_NUMBER}/widgets
          
          # HTML отчёт
          if [ -f swagger-coverage-report.html ]; then
            sudo cp swagger-coverage-report.html allure-history/${GITHUB_RUN_NUMBER}/
          fi
          
          # JSON с покрытием
          if [ -f swagger-coverage-results.json ]; then
            sudo cp swagger-coverage-results.json \
              allure-history/${GITHUB_RUN_NUMBER}/widgets/swagger-coverage.json
          elif [ -f target/swagger-coverage-output/swagger-coverage-results.json ]; then
            sudo cp target/swagger-coverage-output/swagger-coverage-results.json \
              allure-history/${GITHUB_RUN_NUMBER}/widgets/swagger-coverage.json
          else
            echo "⚠️ swagger-coverage JSON not found"
          fi
            
      # ------------------------
      # COVERAGE QUALITY GATE
      # ------------------------
      - name: API coverage quality gate (>=50%)
        if: always()
        run: |
          sudo apt-get update -y && sudo apt-get install -y jq
          
          CANDIDATES=(
            "allure-history/${GITHUB_RUN_NUMBER}/widgets/swagger-coverage.json"
            "allure-history/${GITHUB_RUN_NUMBER}/widgets/coverage.json"
            "allure-report/widgets/swagger-coverage.json"
            "allure-results/swagger-coverage.json"
          )
          
          FILE=""
          for f in "${CANDIDATES[@]}"; do
            if [ -f "$f" ]; then FILE="$f"; break; fi
          done
          [ -z "$FILE" ] && echo "Coverage JSON not found" && exit 1
          
          PCT=$(jq -r '
            if (.summary?.coverage?) then .summary.coverage
            elif (.coverage?) then .coverage
            else empty end
          ' "$FILE")
          
          awk -v p="$PCT" -v t="50" 'BEGIN{
            if (p<=1) p*=100;
            if (p<t) { printf "❌ Coverage %.2f%% < %d%%\n", p, t; exit 1 }
            else     { printf "✅ Coverage %.2f%% >= %d%%\n", p, t; exit 0 }
          }'
            
      # ------------------------
      #   DEPLOY GH-PAGES
      # ------------------------
      - name: Publish test report
        uses: peaceiris/actions-gh-pages@v3
        if: always()
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-history

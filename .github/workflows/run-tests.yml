name: Run tests

# —Ç—Ä–∏–≥–≥–µ—Ä
on: [ push, workflow_dispatch ]

jobs: # –∞–Ω–∞–ª–æ–≥ —ç—Ç–∞–ø–æ–≤
  run-tests:
    name: Set up services (review apps) and run tests
    runs-on: ubuntu-latest
    steps: # —à–∞–≥–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π job
      - name: Checkout repository # –∫–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –≤–Ω—É—Ç—Ä—å CI –∞–≥–µ–Ω—Ç–∞
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'corretto'
          java-version: '21'

      - name: Cache Maven repository
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Install jq if needed
        run: |
          if ! command -v jq &> /dev/null; then
            echo "Installing jq..."
            sudo apt-get update && sudo apt-get install -y jq
          else
            echo "jq is already installed: $(jq --version)"
          fi

      - name: Set up services
        run: cd infra/docker_compose && bash restart_docker.sh && cd ../..

      - name: Wait for services to be ready
        run: |
          echo "Waiting for services to start..."
          sleep 20
          echo "Checking services status..."
          docker ps
          echo "Checking if services are accessible..."
          timeout 30 bash -c 'until curl -f http://localhost:4111/actuator/health 2>/dev/null; do echo "Waiting for backend..."; sleep 2; done' || true
          timeout 30 bash -c 'until curl -f http://localhost:4444/status 2>/dev/null; do echo "Waiting for Selenoid..."; sleep 2; done' || true
          timeout 30 bash -c 'until curl -f http://localhost:80 2>/dev/null; do echo "Waiting for frontend..."; sleep 2; done' || true

      - name: Make Maven wrapper executable
        run: chmod +x ./mvnw

      - name: Run API tests
        run: ./mvnw clean test -q -P api
        env:
          APIBASEURL: http://localhost:4111
          APIVERSION: /api/v1

      - name: Run UI tests
        run: ./mvnw clean test -q -P ui
        env:
          APIBASEURL: http://localhost:4111
          UIBASEURL: http://nginx:80
          UIREMOTE: http://localhost:4444/wd/hub
          APIVERSION: /api/v1

      # ------------------------
      # DEBUG BEFORE SWAGGER COVERAGE
      # ------------------------
      - name: Debug Swagger Coverage
        run: |
          echo "üìÇ Current directory:"
          pwd
          ls -la
          echo "üìÇ target directory:"
          ls -la target || true
          echo "üìÇ target/swagger-coverage-output directory:"
          ls -la target/swagger-coverage-output || true

          echo "üåê Checking API endpoint availability..."
          curl -v http://localhost:4111/v3/api-docs || true

          echo "üìù Checking coverage JSON if it exists..."
          if [ -f target/swagger-coverage-output/swagger-coverage-results.json ]; then
            echo "Coverage JSON found!"
            head -n 20 target/swagger-coverage-output/swagger-coverage-results.json
          else
            echo "‚ö†Ô∏è Coverage JSON not found!"
          fi

          echo "‚ö° Attempting to run Swagger Coverage in verbose mode..."
          chmod +x ./.swagger-coverage-commandline/bin/swagger-coverage-commandline
          ./.swagger-coverage-commandline/bin/swagger-coverage-commandline \
            -s http://localhost:4111/v3/api-docs \
            -i target/swagger-coverage-output \
            --verbose || echo "Swagger Coverage exited with error, debug info above"

      - name: Run Swagger coverage
        if: always()
        run: |
          chmod +x ./.swagger-coverage-commandline/bin/swagger-coverage-commandline
          ./.swagger-coverage-commandline/bin/swagger-coverage-commandline \
          -s http://localhost:4111/v3/api-docs \
          -i target/swagger-coverage-output

      # ------------------------
      # LOAD HISTORY FROM GH-PAGES
      # ------------------------
      - name: Load test report history
        uses: actions/checkout@v4
        if: always()
        with:
          ref: gh-pages
          path: gh-pages

      # ------------------------
      #   INSTALL ALLURE CLI
      # ------------------------
      - name: Download Allure CLI
        if: always()
        run: |
          wget https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.zip
          unzip allure-2.27.0.zip -d allure

      # ------------------------
      #   GENERATE ALLURE REPORT
      # ------------------------
      - name: Build Allure Test Report
        if: always()
        run: |
          ./allure/allure-2.27.0/bin/allure generate target/allure-results \
            -o allure-report --clean
                
          # story:
          # –ø–µ—Ä–µ–Ω–æ—Å–∏–º –∏—Å—Ç–æ—Ä–∏—é
          rm -rf allure-report/history
          if [ -d gh-pages/history ]; then
            cp -R gh-pages/history allure-report/
          fi
          
          # —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∑–∞–ø—É—Å–∫–∞
          mkdir -p allure-history
          cp -R allure-report/* allure-history/
            
      # ------------------------
      # SWAGGER COVERAGE ‚Üí –í–°–¢–†–ê–ò–í–ê–ï–ú –í ALLURE
      # ------------------------
      - name: Build Swagger coverage report
        if: always()
        run: |
          mkdir -p allure-history/${GITHUB_RUN_NUMBER}/widgets
          
          # HTML –æ—Ç—á—ë—Ç
          if [ -f swagger-coverage-report.html ]; then
            sudo cp swagger-coverage-report.html allure-history/${GITHUB_RUN_NUMBER}/
          fi
          
          # JSON —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º
          if [ -f swagger-coverage-results.json ]; then
            sudo cp swagger-coverage-results.json \
              allure-history/${GITHUB_RUN_NUMBER}/widgets/swagger-coverage.json
          elif [ -f target/swagger-coverage-output/swagger-coverage-results.json ]; then
            sudo cp target/swagger-coverage-output/swagger-coverage-results.json \
              allure-history/${GITHUB_RUN_NUMBER}/widgets/swagger-coverage.json
          else
            echo "‚ö†Ô∏è swagger-coverage JSON not found"
          fi
            
      # ------------------------
      #   DEPLOY GH-PAGES
      # ------------------------
      - name: Publish test report
        uses: peaceiris/actions-gh-pages@v3
        if: always()
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-history
